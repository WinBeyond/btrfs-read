@startuml Btrfs Read Service Architecture

!define RECTANGLE class

skinparam componentStyle rectangle
skinparam backgroundColor #FEFEFE
skinparam component {
    BackgroundColor<<application>> #E3F2FD
    BackgroundColor<<filesystem>> #FFF3E0
    BackgroundColor<<btree>> #E8F5E9
    BackgroundColor<<logical>> #FCE4EC
    BackgroundColor<<physical>> #F3E5F5
    BorderColor #424242
    ArrowColor #424242
}

title Btrfs 文件系统读取服务 - 分层架构

package "应用层 (Application Layer)" <<application>> {
    [FUSE Interface] as fuse
    [CLI Tool] as cli
    [Public API] as api
    
    note right of fuse
        - FUSE 文件系统接口
        - 挂载/卸载
        - getattr, read, readdir
    end note
}

package "文件系统层 (Filesystem Layer)" <<filesystem>> {
    [Inode Manager] as inode
    [Directory Reader] as dir
    [File Reader] as file
    [Symlink Handler] as symlink
    
    note right of inode
        - 路径解析
        - Inode 信息读取
        - DIR_ITEM 查找
    end note
}

package "B-Tree 层 (B-Tree Layer)" <<btree>> {
    [B-Tree Searcher] as btree_search
    [Node Parser] as node_parser
    [Key Comparator] as key_comp
    [Path Manager] as path_mgr
    
    note right of btree_search
        - 递归搜索
        - 二分查找
        - 叶节点/内部节点处理
    end note
}

package "逻辑块层 (Logical Block Layer)" <<logical>> {
    [Chunk Manager] as chunk_mgr
    [Volume Manager] as vol_mgr
    [RAID Handler] as raid
    [Address Mapper] as addr_map
    
    note right of chunk_mgr
        - Chunk Tree 解析
        - 逻辑地址 → 物理地址
        - 红黑树索引
    end note
}

package "物理块层 (Physical Block Layer)" <<physical>> {
    [Block Device] as block_dev
    [Superblock Reader] as super
    [Block Cache] as cache
    [Checksum Verifier] as checksum
    [Decompressor] as decompress
    
    note right of block_dev
        - 设备 I/O
        - ReadAt 接口
        - 多设备支持
    end note
}

' 应用层依赖关系
fuse -down-> api
cli -down-> api
api -down-> inode
api -down-> dir
api -down-> file

' 文件系统层依赖关系
inode -down-> btree_search
dir -down-> btree_search
file -down-> btree_search
file -down-> decompress
file -down-> checksum

' B-Tree 层依赖关系
btree_search -down-> node_parser
btree_search -down-> key_comp
btree_search -down-> path_mgr
btree_search -down-> chunk_mgr
node_parser -down-> cache

' 逻辑层依赖关系
chunk_mgr -down-> vol_mgr
chunk_mgr -down-> raid
chunk_mgr -down-> addr_map
addr_map -down-> block_dev

' 物理层依赖关系
super -down-> block_dev
cache -down-> block_dev
checksum -down-> cache

' 说明
legend right
    | 层次 | 职责 |
    | 应用层 | 提供用户接口 (FUSE/CLI/API) |
    | 文件系统层 | 文件和目录操作 |
    | B-Tree 层 | 元数据索引和搜索 |
    | 逻辑块层 | 地址映射和 RAID 处理 |
    | 物理块层 | 设备 I/O 和缓存 |
end legend

@enduml
